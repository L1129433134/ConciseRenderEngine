### shadow mapping原理
#### depth map的构建
- 先正常定义场景的顶点属性（顶点位置、法线等）
- 设置一个framebuffer，设置一个depth map纹理对象绑定到该framebuffer上。
- 渲染场景到depthmap中：1.启用设置depthmao的shader，顶点着色器中把顶点位置转换到了光源坐标系，片段着色器中main函数可以什么都不写，因为启用了深度测试，会自动渲染深度到纹理中。2.绑定framebuffer，激活纹理单元，绘制场景。

#### 使用depth map生成纹理
- 渲染场景：顶点着色器记录了场景顶点的世界坐标、世界法线、纹理坐标、光照坐标系下的坐标，前三者用来计算光照和着色，最后一项用来判断阴影；光照坐标系下的坐标经过透视除法和标准设备变换，xy是用来取depth map中的坐标，z就是深度，若z>depth说明中间有其他物体，则有阴影，否则没阴影。
- 阴影渲染完毕，但存在问题：阴影失真、悬浮、锯齿、采样过多

```
1. 阴影失真的问题产生的原因是当光源较远且与多个片段有一定角度，生成深度图过程中多个片段生成了一个深度点，导致在使用过程中，片段使用的z值可能在这个深度前面也可能在后面，导致了这一问题的产生，于是需要给一个偏移。
2. 悬浮的原因是给的偏移过大
3. 锯齿的解决办法是PCF，一般使用采样周围9个像素取均值的办法解决。
4. 采样过多的原因是已经超出了深度图的范围。
5. 注意生成和使用深度图的时候使用哪种投影，一般正交投影适合平行光照，透视投影适合点光源或聚光灯。 
```